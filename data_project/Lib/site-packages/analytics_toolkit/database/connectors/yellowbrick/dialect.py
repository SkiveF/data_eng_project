from sqlalchemy.dialects.postgresql.psycopg2 import PGDialect_psycopg2


class YellowbrickDialect(PGDialect_psycopg2):
    """
    Dialect for using Yellowbrick in SQLAlchemy. This dialect only supports simple operations. For
    instance, metadata gathering does not seem to work. Statement cache does not seem supported too.
    """

    supports_statement_cache: bool = False

    def _get_server_version_info(self, connection):
        """
        As of June 28th, 2022, Yellowbrick is installed on version 5.2 on Catalina.
        It supports PostgreSQL drivers, with version 9.4 for JDBC and 9.5 for ODBC.
        Check this link: https://www.yellowbrick.com/docs/5.2/connectivity/downloading_drivers.html
        We are then choosing to put the PostgreSQL server version to 9.5.
        However, the optimal way to do it would be to create a custom Yellowbrick dialect.
        Other database providers such as Snowflake, Redshift, etc. have created custom dialects.
        """
        v = connection.exec_driver_sql("select version()").scalar()
        if "Yellowbrick" not in v:
            raise ValueError("Not a Yellowbrick DB!")

        return 9, 5
