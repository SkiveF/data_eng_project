# Catalina - Analytics Toolkit - Statistical Tools

## Description

This package contains statistical tools that can be useful in an Analytics project. Basic usage is
presented here, you can always check the function docstrings for more information.

## Usage

### CALMAR / Icarus

When using the toolkit on the VM only, you can use the Icarus script. Check documentation or tests for more information. As an example:

````python
from pathlib import Path

from analytics_toolkit.execution import get_analytics_logger
from analytics_toolkit.stats import calmar

logger = get_analytics_logger()

# Running CALMAR on a specific DataFrame (Linux only)
df_input = pd.read_csv(Path("to/your/df.csv"))  # can also use a DF that is already loaded
df_output, result = calmar(df_input)
output = result.stdout.decode("UTF-8").split("[1]")

# Log the results of CALMAR
logger.info(output)
````

### Statistical Tests

The toolkit can be used for testing two different populations. Available tests are:

- t-tests: comparing the averages of two numerical distributions.
- KS-tests: Kolmogorov-Smirnov tests checking proximity of two numerical distributions.
- Chi2-tests: comparing frequencies for non-numerical (categorical) variables.

You can also test by segment (using the "segment_by" argument), and change the statistical
significance threshold to your need. Finally, for t-tests you can all weights on both populations if
you want to adjust your comparisons.

````python
from pathlib import Path

from analytics_toolkit.tests import t_test, ks_test, chi2_test

# DFs with 2 populations
df_target = pd.read_csv(Path("targets.csv"))  # can also use a DF that is already loaded
df_controls = pd.read_csv(Path("controls.csv"))  # can also use a DF that is already loaded

# T-test
df_results = t_test(
    df_target, 
    df_control, 
    columns=["num_1", "num_2"],
    segment_by="segment_k7",
    weights_col="poids_calmar",
)

# KS-test
df_results = ks_test(
    df_target, 
    df_control, 
    columns=["num_1", "num_2"], 
    segment_by="segment_k7",
)

# Chi-squared test
df_results = chi2_test(
    df_target, 
    df_control, 
    columns=["categ_1", "categ_2"], 
    segment_by="segment_k7",
    threshold=0.15,
)
````

### Sampling

You can use the toolkit for splitting a population into 2 statistically similar populations, such as
controls and targets, for instance. You can:

- Choose the size of the control population, either as a ratio (0.1) or as a number of clients (1234)
- Do some stratified sampling per segment by using the "stratify_vars" argument
- Control if the two populations are statistically similar, even by the stratified segments, using
  the "control_vars" argument
- Iterate the sampling multiple times to keep the most similar split, using "n_iterations" argument
- Add a column indicating if a customer has been selected, using "add_selected_col_as" argument.

More information in the documentation of the split_target_control function.

````python
from pathlib import Path

from analytics_toolkit.stats import split_target_control

# DFs with 2 populations
df_to_sample = pd.read_csv(Path("targets.csv"))  # can also use a DF that is already loaded

# Sample into 2 DataFrames
df_target, df_control = split_target_control(
    df_target, 
    df_control, 
    control_size=0.1,
    stratify_vars="segment_k7",
    control_vars=["ca", "tr"]
)

# Do not use the new DFs, but write directly and get the test results
_, _, df_tests_results = split_target_control(
    df_target, 
    df_control, 
    control_size=0.1,
    stratify_vars="segment_k7",
    control_vars=["ca", "tr"],
    add_selected_col_as="is_selected",
    include_tests_results=True
)
````

## TO-DO list

- Sampling: make the function work if the one of the segments to stratify has a very low number of observations
